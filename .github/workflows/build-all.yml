name: Build All Platforms

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'Datadog.MAUI.Android.Binding/**'
      - 'Datadog.MAUI.iOS.Binding/**'
      - 'Datadog.MAUI.Plugin/**'
      - 'samples/**'
      - 'scripts/**'
      - 'Directory.Build.props'
      - '.github/workflows/build-all.yml'
      - '.github/workflows/build-android.yml'
      - '.github/workflows/build-ios.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'Datadog.MAUI.Android.Binding/**'
      - 'Datadog.MAUI.iOS.Binding/**'
      - 'Datadog.MAUI.Plugin/**'
      - 'samples/**'
      - 'scripts/**'
      - 'Directory.Build.props'
      - '.github/workflows/build-all.yml'
      - '.github/workflows/build-android.yml'
      - '.github/workflows/build-ios.yml'
  workflow_dispatch:  # Allow manual triggering
  schedule:
    # Run weekly on Monday at 9 AM UTC
    - cron: '0 9 * * 1'

env:
  XCODE_VERSION: '26.2'  # Must be one of https://github.com/actions/runner-images/blob/main/images/macos/macos-15-arm64-Readme.md#xcode

jobs:
  # Verify SDK versions and alignment before building
  verify-sdk-versions:
    name: Verify SDK Versions
    runs-on: ubuntu-latest
    outputs:
      sdk-version: ${{ steps.get-version.outputs.version }}
      sdk-major-minor: ${{ steps.get-version.outputs.major-minor }}
      ios-latest: ${{ steps.check-alignment.outputs.ios-latest }}
      android-latest: ${{ steps.check-alignment.outputs.android-latest }}
      versions-aligned: ${{ steps.check-alignment.outputs.aligned }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Get configured SDK version
        id: get-version
        run: |
          VERSION=$(grep -oPm1 "(?<=<DatadogSdkVersion>)[^<]+" Directory.Build.props)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Configured Datadog SDK version: $VERSION"

          # Extract major.minor version for comparison
          MAJOR_MINOR=$(echo $VERSION | cut -d'.' -f1,2)
          echo "major-minor=$MAJOR_MINOR" >> $GITHUB_OUTPUT
          echo "Major.Minor version: $MAJOR_MINOR"

      - name: Check iOS and Android SDK version alignment
        id: check-alignment
        run: |
          echo "Checking iOS and Android SDK version alignment..."
          echo ""

          # Get latest dd-sdk-ios release
          IOS_LATEST=$(curl -s https://api.github.com/repos/DataDog/dd-sdk-ios/releases/latest | grep '"tag_name"' | sed -E 's/.*"([^"]+)".*/\1/')
          IOS_VERSION=$(echo $IOS_LATEST | sed 's/^v//')
          IOS_MAJOR_MINOR=$(echo $IOS_VERSION | cut -d'.' -f1,2)

          echo "ios-latest=$IOS_VERSION" >> $GITHUB_OUTPUT
          echo "Latest dd-sdk-ios release: $IOS_VERSION (major.minor: $IOS_MAJOR_MINOR)"

          # Get latest dd-sdk-android release
          ANDROID_LATEST=$(curl -s https://api.github.com/repos/DataDog/dd-sdk-android/releases/latest | grep '"tag_name"' | sed -E 's/.*"([^"]+)".*/\1/')
          ANDROID_VERSION=$(echo $ANDROID_LATEST | sed 's/^v//')
          ANDROID_MAJOR_MINOR=$(echo $ANDROID_VERSION | cut -d'.' -f1,2)

          echo "android-latest=$ANDROID_VERSION" >> $GITHUB_OUTPUT
          echo "Latest dd-sdk-android release: $ANDROID_VERSION (major.minor: $ANDROID_MAJOR_MINOR)"
          echo ""

          # Compare major.minor versions
          if [ "$IOS_MAJOR_MINOR" = "$ANDROID_MAJOR_MINOR" ]; then
            echo "aligned=true" >> $GITHUB_OUTPUT
            echo "✅ iOS and Android SDK versions are aligned (both $IOS_MAJOR_MINOR)"
          else
            echo "aligned=false" >> $GITHUB_OUTPUT
            echo "⚠️  Warning: iOS ($IOS_MAJOR_MINOR) and Android ($ANDROID_MAJOR_MINOR) SDK versions differ"
          fi

          # Check if configured version matches latest
          CONFIGURED_MAJOR_MINOR="${{ steps.get-version.outputs.major-minor }}"
          echo ""
          echo "Configured version: $CONFIGURED_MAJOR_MINOR"

          if [ "$CONFIGURED_MAJOR_MINOR" = "$IOS_MAJOR_MINOR" ] && [ "$CONFIGURED_MAJOR_MINOR" = "$ANDROID_MAJOR_MINOR" ]; then
            echo "✅ Configured version matches latest iOS and Android SDKs"
          elif [ "$CONFIGURED_MAJOR_MINOR" = "$IOS_MAJOR_MINOR" ]; then
            echo "✅ Configured version matches latest iOS SDK"
            echo "ℹ️  Differs from latest Android SDK ($ANDROID_MAJOR_MINOR)"
          elif [ "$CONFIGURED_MAJOR_MINOR" = "$ANDROID_MAJOR_MINOR" ]; then
            echo "✅ Configured version matches latest Android SDK"
            echo "ℹ️  Differs from latest iOS SDK ($IOS_MAJOR_MINOR)"
          else
            echo "ℹ️  Configured version differs from latest iOS ($IOS_MAJOR_MINOR) and Android ($ANDROID_MAJOR_MINOR) SDKs"
          fi

      - name: Generate version summary
        run: |
          echo "# SDK Version Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Configured Version**: ${{ steps.get-version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Latest Upstream Versions" >> $GITHUB_STEP_SUMMARY
          echo "- **iOS**: ${{ steps.check-alignment.outputs.ios-latest }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Android**: ${{ steps.check-alignment.outputs.android-latest }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check-alignment.outputs.aligned }}" = "true" ]; then
            echo "✅ **Status**: iOS and Android versions are aligned" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ **Status**: iOS and Android versions differ" >> $GITHUB_STEP_SUMMARY
          fi

  # Call the Android build workflow
  build-android:
    name: Build Android
    needs: verify-sdk-versions
    uses: ./.github/workflows/build-android.yml
    with:
      sdk-version: ${{ needs.verify-sdk-versions.outputs.sdk-version }}

  # Call the iOS build workflow
  build-ios:
    name: Build iOS
    needs: verify-sdk-versions
    uses: ./.github/workflows/build-ios.yml
    with:
      sdk-version: ${{ needs.verify-sdk-versions.outputs.sdk-version }}

  # Build unified Datadog.MAUI plugin package
  build-plugin:
    name: Build Datadog.MAUI Plugin
    runs-on: macos-latest
    needs: [build-android, build-ios, verify-sdk-versions]
    if: needs.build-android.result == 'success' && needs.build-ios.result == 'success'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Cache plugin package
        id: cache-plugin
        uses: actions/cache@v5
        with:
          path: ./artifacts/plugin
          key: ${{ runner.os }}-plugin-package-${{ needs.verify-sdk-versions.outputs.sdk-version }}-${{ hashFiles('Datadog.MAUI.Plugin/**/*.csproj', 'Datadog.MAUI.Plugin/**/*.cs') }}
          restore-keys: |
            ${{ runner.os }}-plugin-package-${{ needs.verify-sdk-versions.outputs.sdk-version }}-

      - name: Setup .NET SDK 10
        if: steps.cache-plugin.outputs.cache-hit != 'true'
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: 10.0.x

      - name: Install .NET workloads
        if: steps.cache-plugin.outputs.cache-hit != 'true'
        run: dotnet workload install maui

      - name: Download Android packages
        if: steps.cache-plugin.outputs.cache-hit != 'true'
        uses: actions/download-artifact@v7
        with:
          name: android-nuget-packages
          path: ./artifacts/android

      - name: Download iOS packages
        if: steps.cache-plugin.outputs.cache-hit != 'true'
        uses: actions/download-artifact@v7
        with:
          name: ios-nuget-packages
          path: ./artifacts/ios

      - name: Download iOS XCFrameworks
        id: download-ios-xcframeworks
        if: steps.cache-plugin.outputs.cache-hit != 'true'
        uses: actions/download-artifact@v7
        with:
          name: ios-xcframeworks
          path: Datadog.MAUI.iOS.Binding/artifacts/

      - name: Setup local NuGet source
        if: steps.cache-plugin.outputs.cache-hit != 'true'
        run: |
          # Create a local NuGet source with all built packages
          mkdir -p ./artifacts/all
          cp -r ./artifacts/android/*.nupkg ./artifacts/all/ 2>/dev/null || true
          cp -r ./artifacts/ios/*.nupkg ./artifacts/all/ 2>/dev/null || true

          # Add local source
          dotnet nuget add source ./artifacts/all --name LocalArtifacts || true

      - name: Restore plugin dependencies (iOS + Android)
        if: steps.cache-plugin.outputs.cache-hit != 'true'
        run: dotnet restore Datadog.MAUI.Plugin/Datadog.MAUI.Plugin.csproj

      - name: Build plugin (iOS + Android)
        if: steps.cache-plugin.outputs.cache-hit != 'true'
        run: dotnet build Datadog.MAUI.Plugin/Datadog.MAUI.Plugin.csproj --configuration Release --no-restore

      - name: Pack plugin (iOS + Android)
        if: steps.cache-plugin.outputs.cache-hit != 'true'
        run: dotnet pack Datadog.MAUI.Plugin/Datadog.MAUI.Plugin.csproj --configuration Release --no-build --output ./artifacts/plugin

      - name: Upload plugin package
        uses: actions/upload-artifact@v6
        with:
          name: datadog-maui-plugin
          path: ./artifacts/plugin/*.nupkg
          retention-days: 30

      - name: Plugin build summary
        run: |
          echo "## Datadog.MAUI Plugin Package" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Plugin package built successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Package**: Datadog.MAUI.${{ needs.verify-sdk-versions.outputs.sdk-version }}.nupkg" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Platform Support**: iOS + Android (full support)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This package provides a unified C# API over Android and iOS bindings." >> $GITHUB_STEP_SUMMARY

  # Build sample apps in parallel for faster feedback
  build-sample-android:
    name: Build Sample (Android)
    runs-on: ubuntu-latest  # Cheaper and faster for Android
    needs: build-plugin
    if: needs.build-plugin.result == 'success'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup .NET SDK 10
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: 10.0.x

      - name: Cache .NET workloads
        uses: actions/cache@v5
        with:
          path: |
            ~/.dotnet/sdk-manifests
            ~/.dotnet/metadata/workloads
            ~/.dotnet/packs
          key: ${{ runner.os }}-dotnet-workload-maui-android-${{ hashFiles('**/global.json', '**/Directory.Build.props') }}
          restore-keys: |
            ${{ runner.os }}-dotnet-workload-maui-android-

      - name: Install MAUI Android workload
        run: dotnet workload install maui-android

      - name: Download Android packages
        uses: actions/download-artifact@v7
        with:
          name: android-nuget-packages
          path: ./artifacts

      - name: Download iOS packages
        uses: actions/download-artifact@v7
        with:
          name: ios-nuget-packages
          path: ./artifacts

      - name: Download plugin package
        uses: actions/download-artifact@v7
        with:
          name: datadog-maui-plugin
          path: ./artifacts

      - name: Verify artifacts
        run: |
          echo "Packages available for Android build:"
          ls -lh ./artifacts/*.nupkg

      - name: Setup local NuGet source and restore
        env:
          DD_RUM_ANDROID_CLIENT_TOKEN: ${{ secrets.DD_RUM_ANDROID_CLIENT_TOKEN }}
          DD_RUM_ANDROID_APPLICATION_ID: ${{ secrets.DD_RUM_ANDROID_APPLICATION_ID }}
        run: |
          # Create nuget.config in sample directory with local source
          cat > samples/DatadogMauiSample/nuget.config << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <configuration>
            <packageSources>
              <clear />
              <add key="LocalArtifacts" value="../../artifacts" />
              <add key="nuget.org" value="https://api.nuget.org/v3/index.json" />
            </packageSources>
          </configuration>
          EOF

          echo "Restoring sample app dependencies (Android only)..."
          cd samples/DatadogMauiSample
          dotnet restore DatadogMauiSample.csproj -f net10.0-android --configfile nuget.config -p:Configuration=Release

      - name: Build sample app (Android)
        env:
          DD_RUM_ANDROID_CLIENT_TOKEN: ${{ secrets.DD_RUM_ANDROID_CLIENT_TOKEN }}
          DD_RUM_ANDROID_APPLICATION_ID: ${{ secrets.DD_RUM_ANDROID_APPLICATION_ID }}
        run: |
          cd samples/DatadogMauiSample
          echo "Building Android (net10.0-android)..."
          dotnet build DatadogMauiSample.csproj -f net10.0-android -c Release --no-restore -v minimal

      - name: Upload Android sample APK
        uses: actions/upload-artifact@v6
        with:
          name: android-sample-apk
          path: samples/DatadogMauiSample/bin/Release/**/*.apk
          if-no-files-found: warn
          retention-days: 7

      - name: Build summary
        run: |
          echo "## Android Sample App Build" >> $GITHUB_STEP_SUMMARY
          echo "✅ Android sample app built successfully" >> $GITHUB_STEP_SUMMARY

  build-sample-ios:
    name: Build Sample (iOS)
    runs-on: macos-latest  # Required for iOS/Xcode
    needs: build-plugin
    if: needs.build-plugin.result == 'success'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup .NET SDK 10
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: 10.0.x

      - name: Cache .NET workloads
        uses: actions/cache@v5
        with:
          path: |
            ~/.dotnet/sdk-manifests
            ~/.dotnet/metadata/workloads
            ~/.dotnet/packs
          key: ${{ runner.os }}-dotnet-workload-maui-ios-${{ hashFiles('**/global.json', '**/Directory.Build.props') }}
          restore-keys: |
            ${{ runner.os }}-dotnet-workload-maui-ios-

      - name: Install MAUI iOS workload
        run: dotnet workload install maui-ios

      - name: Download Android packages
        uses: actions/download-artifact@v7
        with:
          name: android-nuget-packages
          path: ./artifacts

      - name: Download iOS packages
        uses: actions/download-artifact@v7
        with:
          name: ios-nuget-packages
          path: ./artifacts

      - name: Download plugin package
        uses: actions/download-artifact@v7
        with:
          name: datadog-maui-plugin
          path: ./artifacts

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app/Contents/Developer || sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

      - name: Verify artifacts
        run: |
          echo "Packages available for iOS build:"
          ls -lh ./artifacts/*.nupkg

      - name: Setup local NuGet source and restore
        env:
          DD_RUM_IOS_CLIENT_TOKEN: ${{ secrets.DD_RUM_IOS_CLIENT_TOKEN }}
          DD_RUM_IOS_APPLICATION_ID: ${{ secrets.DD_RUM_IOS_APPLICATION_ID }}
        run: |
          # Create nuget.config in sample directory with local source
          cat > samples/DatadogMauiSample/nuget.config << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <configuration>
            <packageSources>
              <clear />
              <add key="LocalArtifacts" value="../../artifacts" />
              <add key="nuget.org" value="https://api.nuget.org/v3/index.json" />
            </packageSources>
          </configuration>
          EOF

          echo "Restoring sample app dependencies (iOS only)..."
          cd samples/DatadogMauiSample
          dotnet restore DatadogMauiSample.csproj -f net10.0-ios --configfile nuget.config -p:Configuration=Release

      - name: Build sample app (iOS)
        env:
          DD_RUM_IOS_CLIENT_TOKEN: ${{ secrets.DD_RUM_IOS_CLIENT_TOKEN }}
          DD_RUM_IOS_APPLICATION_ID: ${{ secrets.DD_RUM_IOS_APPLICATION_ID }}
        run: |
          cd samples/DatadogMauiSample
          echo "Building iOS (net10.0-ios)..."
          dotnet build DatadogMauiSample.csproj -f net10.0-ios -c Release --no-restore -v minimal

      - name: Upload iOS sample app
        uses: actions/upload-artifact@v6
        with:
          name: ios-sample-app
          path: |
            samples/DatadogMauiSample/bin/Release/**/*.app
            samples/DatadogMauiSample/bin/Release/**/*.ipa
          if-no-files-found: warn
          retention-days: 7

      - name: Build summary
        run: |
          echo "## iOS Sample App Build" >> $GITHUB_STEP_SUMMARY
          echo "✅ iOS sample app built successfully" >> $GITHUB_STEP_SUMMARY

      - name: Sample apps summary
        run: |
          echo "## Sample Apps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Android and iOS sample apps built successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Built with unified Datadog.MAUI.${{ needs.verify-sdk-versions.outputs.sdk-version }}" >> $GITHUB_STEP_SUMMARY

  # Validate all builds completed successfully
  validate-builds:
    name: Validate All Builds
    runs-on: ubuntu-latest
    needs: [build-plugin, build-sample-android, build-sample-ios]
    if: always()  # Run even if some builds failed

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Check plugin build status
        id: check-plugin
        run: |
          if [ "${{ needs.build-plugin.result }}" == "success" ]; then
            echo "plugin_success=true" >> $GITHUB_OUTPUT
            echo "✅ Plugin build succeeded"
          else
            echo "plugin_success=false" >> $GITHUB_OUTPUT
            echo "❌ Plugin build failed"
          fi

      - name: Check sample apps build status
        id: check-samples
        run: |
          ANDROID_RESULT="${{ needs.build-sample-android.result }}"
          IOS_RESULT="${{ needs.build-sample-ios.result }}"

          if [ "$ANDROID_RESULT" == "success" ] && [ "$IOS_RESULT" == "success" ]; then
            echo "samples_success=true" >> $GITHUB_OUTPUT
            echo "✅ Sample apps build succeeded (Android + iOS)"
          elif [ "$ANDROID_RESULT" == "success" ] && [ "$IOS_RESULT" != "success" ]; then
            echo "samples_success=partial" >> $GITHUB_OUTPUT
            echo "⚠️  Sample apps build partially succeeded (Android only)"
          elif [ "$ANDROID_RESULT" != "success" ] && [ "$IOS_RESULT" == "success" ]; then
            echo "samples_success=partial" >> $GITHUB_OUTPUT
            echo "⚠️  Sample apps build partially succeeded (iOS only)"
          else
            echo "samples_success=false" >> $GITHUB_OUTPUT
            echo "❌ Sample apps build failed or skipped (both platforms)"
          fi

      - name: Download plugin package
        if: needs.build-plugin.result == 'success'
        uses: actions/download-artifact@v7
        with:
          name: datadog-maui-plugin
          path: ./artifacts
        continue-on-error: true

      - name: List plugin package
        run: |
          echo "=== Plugin Package ==="
          if [ -d "./artifacts" ]; then
            ls -lh ./artifacts/*.nupkg 2>/dev/null || echo "No plugin package found"
          else
            echo "Artifacts directory not found"
          fi

      - name: Verify package versions
        run: |
          echo "Verifying all packages have consistent versioning..."
          if [ -d "./artifacts" ]; then
            find ./artifacts -name "*.nupkg" -exec basename {} \; | sort || echo "No packages found"
          else
            echo "No artifacts directory found"
          fi

      - name: Upload combined artifacts
        if: success()
        uses: actions/upload-artifact@v6
        with:
          name: all-nuget-packages
          path: ./artifacts/**/*.nupkg
          if-no-files-found: ignore
          retention-days: 30

      - name: Generate build summary
        run: |
          echo "# Datadog MAUI SDK Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # SDK Version
          VERSION=$(grep -E '<DatadogSdkVersion>.*</DatadogSdkVersion>' Directory.Build.props | sed 's/.*<DatadogSdkVersion>\(.*\)<\/DatadogSdkVersion>.*/\1/')
          echo "**SDK Version**: $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Build Status
          echo "## Build Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check-plugin.outputs.plugin_success }}" == "true" ]; then
            echo "- ✅ **Plugin**: Built successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ❌ **Plugin**: Build failed" >> $GITHUB_STEP_SUMMARY
          fi

          SAMPLES_STATUS="${{ steps.check-samples.outputs.samples_success }}"
          ANDROID_RESULT="${{ needs.build-sample-android.result }}"
          IOS_RESULT="${{ needs.build-sample-ios.result }}"

          if [ "$SAMPLES_STATUS" == "true" ]; then
            echo "- ✅ **Sample Apps**: Both platforms built successfully" >> $GITHUB_STEP_SUMMARY
            echo "  - ✅ Android: Built successfully" >> $GITHUB_STEP_SUMMARY
            echo "  - ✅ iOS: Built successfully" >> $GITHUB_STEP_SUMMARY
          elif [ "$SAMPLES_STATUS" == "partial" ]; then
            echo "- ⚠️  **Sample Apps**: Partial success" >> $GITHUB_STEP_SUMMARY
            if [ "$ANDROID_RESULT" == "success" ]; then
              echo "  - ✅ Android: Built successfully" >> $GITHUB_STEP_SUMMARY
            else
              echo "  - ❌ Android: Build failed or skipped" >> $GITHUB_STEP_SUMMARY
            fi
            if [ "$IOS_RESULT" == "success" ]; then
              echo "  - ✅ iOS: Built successfully" >> $GITHUB_STEP_SUMMARY
            else
              echo "  - ❌ iOS: Build failed or skipped" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "- ❌ **Sample Apps**: Build failed or skipped (both platforms)" >> $GITHUB_STEP_SUMMARY
            echo "  - ❌ Android: Build failed or skipped" >> $GITHUB_STEP_SUMMARY
            echo "  - ❌ iOS: Build failed or skipped" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # Plugin Package
          echo "## Plugin Package" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -d "./artifacts" ] && ls ./artifacts/Datadog.MAUI.*.nupkg >/dev/null 2>&1; then
            echo "**Datadog.MAUI Plugin**: ✅ Created" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            ls -1 ./artifacts/Datadog.MAUI.*.nupkg 2>/dev/null | xargs -n1 basename >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "**Datadog.MAUI Plugin**: ❌ Not found" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # Target Frameworks
          echo "## Target Frameworks" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All packages support multi-framework targeting:" >> $GITHUB_STEP_SUMMARY
          echo "- **Android**: net9.0-android, net10.0-android" >> $GITHUB_STEP_SUMMARY
          echo "- **iOS**: net8.0-ios, net9.0-ios, net10.0-ios" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Build triggered by: ${{ github.event_name }}*" >> $GITHUB_STEP_SUMMARY

      - name: Fail if critical builds failed
        if: needs.build-plugin.result != 'success'
        run: |
          echo "❌ Plugin build failed - this is a critical failure"
          exit 1

  # Optional: Create GitHub release (when tagged)
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: validate-builds
    if: github.ref_type == 'tag' && startsWith(github.ref_name, 'v')
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Download all packages
        uses: actions/download-artifact@v7
        with:
          name: all-nuget-packages
          path: ./release-artifacts

      - name: Get version from tag
        id: get-version
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/v}
          echo "version=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "Release version: $TAG_NAME"

      - name: Generate checksums
        run: |
          cd ./release-artifacts
          find . -name "*.nupkg" -exec sha256sum {} \; > checksums.txt
          echo "=== SHA256 Checksums ==="
          cat checksums.txt

      - name: Create release notes
        run: |
          # Extract package names from artifacts and categorize them
          cd ./release-artifacts

          # Get all unique package IDs (strip version and .nupkg)
          PLUGIN_PACKAGES=$(ls Datadog.MAUI.*.nupkg 2>/dev/null | grep -v "Android\|iOS" | sed 's/\.[0-9]\+\.[0-9]\+\.[0-9]\+\.nupkg$//' | sort -u)
          ANDROID_PACKAGES=$(ls Datadog.MAUI.Android.*.nupkg 2>/dev/null | grep -v "\.Binding\." | sed 's/\.[0-9]\+\.[0-9]\+\.[0-9]\+\.nupkg$//' | sort -u)
          IOS_PACKAGES=$(ls Datadog.MAUI.iOS.*.nupkg 2>/dev/null | grep -v "\.Binding\." | sed 's/\.[0-9]\+\.[0-9]\+\.[0-9]\+\.nupkg$//' | sort -u)
          META_PACKAGES=$(ls Datadog.MAUI.*.Binding.*.nupkg 2>/dev/null | sed 's/\.[0-9]\+\.[0-9]\+\.[0-9]\+\.nupkg$//' | sort -u)

          # Start building release notes
          cat > ../release-notes.md << EOF
          # Datadog MAUI SDK ${{ steps.get-version.outputs.version }}

          .NET MAUI bindings for Datadog's native iOS and Android Mobile SDKs.

          ## Packages

          This release includes the following NuGet packages:

          EOF

          # Add Unified Plugin section
          if [ -n "$PLUGIN_PACKAGES" ]; then
            echo "### Unified Plugin" >> ../release-notes.md
            echo "" >> ../release-notes.md
            for pkg in $PLUGIN_PACKAGES; do
              echo "- **$pkg** - Cross-platform unified API for both iOS and Android" >> ../release-notes.md
            done
            echo "" >> ../release-notes.md
          fi

          # Add Android packages
          if [ -n "$ANDROID_PACKAGES" ]; then
            echo "### Android Bindings" >> ../release-notes.md
            echo "" >> ../release-notes.md
            echo "$ANDROID_PACKAGES" | while read pkg; do
              echo "- $pkg" >> ../release-notes.md
            done
            echo "" >> ../release-notes.md
          fi

          # Add iOS packages
          if [ -n "$IOS_PACKAGES" ]; then
            echo "### iOS Bindings" >> ../release-notes.md
            echo "" >> ../release-notes.md
            echo "$IOS_PACKAGES" | while read pkg; do
              echo "- $pkg" >> ../release-notes.md
            done
            echo "" >> ../release-notes.md
          fi

          # Add Meta-Packages
          if [ -n "$META_PACKAGES" ]; then
            echo "### Meta-Packages" >> ../release-notes.md
            echo "" >> ../release-notes.md
            echo "$META_PACKAGES" | while read pkg; do
              echo "- $pkg" >> ../release-notes.md
            done
            echo "" >> ../release-notes.md
          fi

          # Add remaining sections
          cat >> ../release-notes.md << 'ENDEOF'
          ## Target Frameworks

          All packages support:
          - net9.0-android / net9.0-ios
          - net10.0-android / net10.0-ios

          ## Installation

          For most users, install the unified plugin:
          ```bash
          dotnet add package Datadog.MAUI --version ${{ steps.get-version.outputs.version }}
          ```

          Or install platform-specific bindings:
          ```bash
          dotnet add package Datadog.MAUI.Android.Core --version ${{ steps.get-version.outputs.version }}
          dotnet add package Datadog.MAUI.iOS.Core --version ${{ steps.get-version.outputs.version }}
          ```

          ## Documentation

          See the [documentation](https://github.com/DataDog/dd-sdk-maui/tree/main/docs) for usage guides and API reference.

          ## What's Changed

          See [CHANGELOG.md](https://github.com/DataDog/dd-sdk-maui/blob/main/docs/CHANGELOG.md) for detailed changes.
          ENDEOF

          cd ..
          echo "=== Generated Release Notes ==="
          cat release-notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ steps.get-version.outputs.version }}
          body_path: release-notes.md
          files: |
            ./release-artifacts/**/*.nupkg
            ./release-artifacts/checksums.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release summary
        run: |
          echo "## GitHub Release Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: ${{ steps.get-version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tag**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All NuGet packages have been attached to the release." >> $GITHUB_STEP_SUMMARY