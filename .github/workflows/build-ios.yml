name: Build iOS Bindings

on:
  workflow_call:  # Allow this workflow to be called by other workflows
    inputs:
      sdk-version:
        description: 'SDK version to build (optional, reads from Directory.Build.props if not provided)'
        required: false
        type: string
  workflow_dispatch:  # Allow manual triggering
    inputs:
      sdk-version:
        description: 'SDK version to build (optional, reads from Directory.Build.props if not provided)'
        required: false
        type: string

env:
  XCODE_VERSION: '26.2'  # Must be one of https://github.com/actions/runner-images/blob/main/images/macos/macos-15-arm64-Readme.md#xcode

jobs:
  # Download XCFrameworks once and share across builds (requires macOS)
  download-xcframeworks:
    name: Download XCFrameworks
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Get SDK version
        id: sdk-version
        run: |
          # Use input version if provided, otherwise read from Directory.Build.props
          if [ -n "${{ inputs.sdk-version }}" ]; then
            VERSION="${{ inputs.sdk-version }}"
            echo "Using provided SDK version: $VERSION"
          else
            VERSION=$(grep -E '<DatadogSdkVersion>.*</DatadogSdkVersion>' Directory.Build.props | sed 's/.*<DatadogSdkVersion>\(.*\)<\/DatadogSdkVersion>.*/\1/')
            echo "Read SDK version from Directory.Build.props: $VERSION"
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Datadog iOS SDK version: $VERSION"

      - name: Cache XCFrameworks
        id: cache-xcframeworks
        uses: actions/cache@v5
        with:
          path: Datadog.MAUI.iOS.Binding/artifacts/*.xcframework
          key: ${{ runner.os }}-xcframeworks-${{ steps.sdk-version.outputs.version }}
          restore-keys: |
            ${{ runner.os }}-xcframeworks-

      - name: Select Xcode version
        if: steps.cache-xcframeworks.outputs.cache-hit != 'true'
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app/Contents/Developer || sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

      - name: Setup iOS XCFrameworks
        if: steps.cache-xcframeworks.outputs.cache-hit != 'true'
        run: |
          chmod +x scripts/download-ios-frameworks.sh
          scripts/download-ios-frameworks.sh ${{ steps.sdk-version.outputs.version }} Datadog.MAUI.iOS.Binding

      - name: Verify XCFrameworks downloaded
        run: |
          echo "XCFrameworks found:"
          ls -la Datadog.MAUI.iOS.Binding/artifacts/*.xcframework || echo "No XCFrameworks found"

      - name: Upload XCFrameworks
        uses: actions/upload-artifact@v6
        with:
          name: ios-xcframeworks
          path: Datadog.MAUI.iOS.Binding/artifacts/*.xcframework
          retention-days: 1

      - name: Upload download logs on failure
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: xcframework-download-logs
          path: |
            **/*.log
          if-no-files-found: ignore
          retention-days: 3

  # Build with .NET 9 for net9.0-ios support
  build-ios-net9:
    name: Build iOS (net9.0-ios)
    runs-on: macos-latest
    needs: download-xcframeworks

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Download XCFrameworks
        uses: actions/download-artifact@v7
        with:
          name: ios-xcframeworks
          path: Datadog.MAUI.iOS.Binding/artifacts/

      - name: Verify XCFrameworks
        run: ls -la Datadog.MAUI.iOS.Binding/artifacts/

      - name: Setup .NET SDK 9
        uses: actions/setup-dotnet@v5
        id: setup-dotnet-9
        with:
          dotnet-version: 9.0.x

      - name: Create temporary global.json for SDK 9
        run: echo '{"sdk":{"version":"${{ steps.setup-dotnet-9.outputs.dotnet-version }}","rollForward":"latestPatch"}}' > ./global.json

      - name: Verify SDK version
        run: dotnet --version

      - name: Cache .NET workloads
        uses: actions/cache@v5
        with:
          path: |
            ~/.dotnet/sdk-manifests
            ~/.dotnet/metadata
            ~/.dotnet/workloadsets
            ~/.nuget/packages
          key: ${{ runner.os }}-dotnet-workload-ios-${{ steps.setup-dotnet-9.outputs.dotnet-version }}
          restore-keys: |
            ${{ runner.os }}-dotnet-workload-ios-

      - name: Install .NET iOS workload
        run: dotnet workload install ios

      - name: Get SDK version for cache key
        id: sdk-version
        run: |
          VERSION=$(grep -E '<DatadogSdkVersion>.*</DatadogSdkVersion>' Directory.Build.props | sed 's/.*<DatadogSdkVersion>\(.*\)<\/DatadogSdkVersion>.*/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Cache NuGet packages (net9.0-ios)
        id: cache-nuget-net9
        uses: actions/cache@v5
        with:
          path: ./artifacts-net9/*.nupkg
          key: ${{ runner.os }}-ios-net9-packages-${{ steps.sdk-version.outputs.version }}-${{ hashFiles('Datadog.MAUI.iOS.Binding/**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-ios-net9-packages-${{ steps.sdk-version.outputs.version }}-

      - name: Restore dependencies (individual packages only)
        if: steps.cache-nuget-net9.outputs.cache-hit != 'true'
        run: |
          # Restore individual packages, skip meta-package
          for dir in Datadog.MAUI.iOS.Binding/Datadog*; do
            if [ -d "$dir" ] && [ -f "$dir"/*.csproj ] && [[ "$(basename $dir)" != "Datadog.MAUI.iOS.Binding" ]]; then
              echo "Restoring $(basename $dir)..."
              dotnet restore "$dir" -p:TargetFrameworks=net9.0-ios
            fi
          done
        continue-on-error: true  # iOS bindings not complete yet

      - name: Build iOS bindings (net9.0-ios)
        if: steps.cache-nuget-net9.outputs.cache-hit != 'true'
        run: |
          # Build individual packages, skip meta-package
          for dir in Datadog.MAUI.iOS.Binding/Datadog*; do
            if [ -d "$dir" ] && [ -f "$dir"/*.csproj ] && [[ "$(basename $dir)" != "Datadog.MAUI.iOS.Binding" ]]; then
              echo "Building $(basename $dir)..."
              dotnet build "$dir" --configuration Release --no-restore -p:TargetFrameworks=net9.0-ios
            fi
          done
        continue-on-error: true  # iOS bindings not complete yet

      - name: Pack NuGet packages (net9.0-ios)
        if: steps.cache-nuget-net9.outputs.cache-hit != 'true'
        run: |
          # Pack individual packages (excluding meta-package)
          for dir in Datadog.MAUI.iOS.Binding/Datadog*; do
            if [ -d "$dir" ] && [ -f "$dir"/*.csproj ] && [[ "$(basename $dir)" != "Datadog.MAUI.iOS.Binding" ]]; then
              echo "Packing $(basename $dir)..."
              dotnet pack "$dir" --configuration Release --no-build --output ./artifacts-net9 -p:TargetFrameworks=net9.0-ios
            fi
          done
        continue-on-error: true  # iOS bindings not complete yet

      - name: Upload net9.0-ios packages
        if: success()
        uses: actions/upload-artifact@v6
        with:
          name: ios-nuget-packages-net9
          path: ./artifacts-net9/*.nupkg
          if-no-files-found: warn
          retention-days: 7

      - name: Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: ios-net9-build-logs
          path: |
            **/*.binlog
            **/bin/**/*.log
          if-no-files-found: ignore
          retention-days: 3

  # Build with .NET 10 for net10.0-ios support
  build-ios-net10:
    name: Build iOS (net10.0-ios)
    runs-on: macos-latest
    needs: download-xcframeworks

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Download XCFrameworks
        uses: actions/download-artifact@v7
        with:
          name: ios-xcframeworks
          path: Datadog.MAUI.iOS.Binding/artifacts/

      - name: Verify XCFrameworks
        run: ls -la Datadog.MAUI.iOS.Binding/artifacts/

      - name: Remove global.json to allow SDK 10+
        run: rm -f global.json

      - name: Setup .NET SDK 10
        uses: actions/setup-dotnet@v5
        id: setup-dotnet-10
        with:
          dotnet-version: 10.0.x

      - name: Verify SDK version
        run: dotnet --version

      - name: Cache .NET workloads
        uses: actions/cache@v5
        with:
          path: |
            ~/.dotnet/sdk-manifests
            ~/.dotnet/metadata
            ~/.dotnet/workloadsets
            ~/.nuget/packages
          key: ${{ runner.os }}-dotnet-workload-ios-${{ steps.setup-dotnet-10.outputs.dotnet-version }}
          restore-keys: |
            ${{ runner.os }}-dotnet-workload-ios-

      - name: Install .NET iOS workload
        run: dotnet workload install ios

      - name: Get SDK version for cache key
        id: sdk-version
        run: |
          VERSION=$(grep -E '<DatadogSdkVersion>.*</DatadogSdkVersion>' Directory.Build.props | sed 's/.*<DatadogSdkVersion>\(.*\)<\/DatadogSdkVersion>.*/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Cache NuGet packages (net10.0-ios)
        id: cache-nuget-net10
        uses: actions/cache@v5
        with:
          path: ./artifacts-net10/*.nupkg
          key: ${{ runner.os }}-ios-net10-packages-${{ steps.sdk-version.outputs.version }}-${{ hashFiles('Datadog.MAUI.iOS.Binding/**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-ios-net10-packages-${{ steps.sdk-version.outputs.version }}-

      - name: Restore dependencies (individual packages only)
        if: steps.cache-nuget-net10.outputs.cache-hit != 'true'
        run: |
          # Restore individual packages, skip meta-package
          for dir in Datadog.MAUI.iOS.Binding/Datadog*; do
            if [ -d "$dir" ] && [ -f "$dir"/*.csproj ] && [[ "$(basename $dir)" != "Datadog.MAUI.iOS.Binding" ]]; then
              echo "Restoring $(basename $dir)..."
              dotnet restore "$dir" -p:TargetFrameworks=net10.0-ios
            fi
          done
        continue-on-error: true  # iOS bindings not complete yet

      - name: Build iOS bindings (net10.0-ios)
        if: steps.cache-nuget-net10.outputs.cache-hit != 'true'
        run: |
          # Build individual packages, skip meta-package
          for dir in Datadog.MAUI.iOS.Binding/Datadog*; do
            if [ -d "$dir" ] && [ -f "$dir"/*.csproj ] && [[ "$(basename $dir)" != "Datadog.MAUI.iOS.Binding" ]]; then
              echo "Building $(basename $dir)..."
              dotnet build "$dir" --configuration Release --no-restore -p:TargetFrameworks=net10.0-ios
            fi
          done
        continue-on-error: true  # iOS bindings not complete yet

      - name: Pack NuGet packages (net10.0-ios)
        if: steps.cache-nuget-net10.outputs.cache-hit != 'true'
        run: |
          # Pack individual packages (excluding meta-package)
          for dir in Datadog.MAUI.iOS.Binding/Datadog*; do
            if [ -d "$dir" ] && [ -f "$dir"/*.csproj ] && [[ "$(basename $dir)" != "Datadog.MAUI.iOS.Binding" ]]; then
              echo "Packing $(basename $dir)..."
              dotnet pack "$dir" --configuration Release --no-build --output ./artifacts-net10 -p:TargetFrameworks=net10.0-ios
            fi
          done
        continue-on-error: true  # iOS bindings not complete yet

      - name: Upload net10.0-ios packages
        if: success()
        uses: actions/upload-artifact@v6
        with:
          name: ios-nuget-packages-net10
          path: ./artifacts-net10/*.nupkg
          if-no-files-found: warn
          retention-days: 7

      - name: Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: ios-net10-build-logs
          path: |
            **/*.binlog
            **/bin/**/*.log
          if-no-files-found: ignore
          retention-days: 3

  # Combine all target frameworks into unified packages
  combine-ios-packages:
    name: Combine iOS Packages
    runs-on: macos-latest  # macOS required for packing iOS meta-package
    needs: [build-ios-net9, build-ios-net10]
    if: success() || failure()  # Run even if builds failed (iOS incomplete)

    steps:
      - name: Check if packages exist
        id: check-packages
        run: |
          echo "Checking for iOS packages..."
          echo "packages_exist=false" >> $GITHUB_OUTPUT

      - name: Download net9.0-ios packages
        if: success()
        uses: actions/download-artifact@v7
        with:
          name: ios-nuget-packages-net9
          path: ./artifacts-net9
        continue-on-error: true

      - name: Download net10.0-ios packages
        if: success()
        uses: actions/download-artifact@v7
        with:
          name: ios-nuget-packages-net10
          path: ./artifacts-net10
        continue-on-error: true

      - name: Combine packages for all target frameworks
        if: success()
        run: |
          mkdir -p ./artifacts-combined
          mkdir -p ./temp-extract

          # Check if we have any packages to combine (try net9 first, then net10)
          if [ -d "./artifacts-net9" ] && [ -n "$(ls -A ./artifacts-net9/*.nupkg 2>/dev/null)" ]; then
            BASE_DIR="./artifacts-net9"
            echo "Using net9.0-ios as base"
          elif [ -d "./artifacts-net10" ] && [ -n "$(ls -A ./artifacts-net10/*.nupkg 2>/dev/null)" ]; then
            BASE_DIR="./artifacts-net10"
            echo "Using net10.0-ios as base"
          else
            echo "No iOS packages found, skipping combine"
            exit 0
          fi

          # Process each package
          for base_pkg in $BASE_DIR/*.nupkg; do
            pkg_name=$(basename "$base_pkg" | sed 's/\.[0-9]\+\.[0-9]\+\.[0-9]\+.*\.nupkg$//')
            version=$(basename "$base_pkg" | sed -n 's/.*\.\([0-9]\+\.[0-9]\+\.[0-9]\+[^.]*\)\.nupkg$/\1/p')

            net9_pkg="./artifacts-net9/${pkg_name}.${version}.nupkg"
            net10_pkg="./artifacts-net10/${pkg_name}.${version}.nupkg"

            echo "Processing $pkg_name version $version"

            # Extract base package
            unzip -q "$base_pkg" -d "./temp-extract/base"

            # Copy net9.0-ios if it exists and we're not already using it as base
            if [ -f "$net9_pkg" ] && [ "$BASE_DIR" != "./artifacts-net9" ]; then
              unzip -q "$net9_pkg" -d "./temp-extract/net9"
              for net9_dir in "./temp-extract/net9/lib"/net9.0-ios*; do
                if [ -d "$net9_dir" ]; then
                  cp -r "$net9_dir" "./temp-extract/base/lib/"
                  echo "  Copied net9.0-ios framework"
                fi
              done
              rm -rf "./temp-extract/net9"
            fi

            # Copy net10.0-ios if it exists and we're not already using it as base
            if [ -f "$net10_pkg" ] && [ "$BASE_DIR" != "./artifacts-net10" ]; then
              unzip -q "$net10_pkg" -d "./temp-extract/net10"
              for net10_dir in "./temp-extract/net10/lib"/net10.0-ios*; do
                if [ -d "$net10_dir" ]; then
                  cp -r "$net10_dir" "./temp-extract/base/lib/"
                  echo "  Copied net10.0-ios framework"
                fi
              done
              rm -rf "./temp-extract/net10"
            fi

            # Repackage the combined content
            (cd "./temp-extract/base" && zip -q -r "../../artifacts-combined/${pkg_name}.${version}.nupkg" *)

            # Clean up temp directories
            rm -rf "./temp-extract/base"

            echo "  ✅ Created combined package: ${pkg_name}.${version}.nupkg"
          done

          echo ""
          echo "Combined packages:"
          ls -lh ./artifacts-combined/ || echo "No packages created"
        continue-on-error: true

      - name: Verify combined packages before meta-package build
        if: success()
        run: |
          echo "Checking artifacts-combined directory..."
          ls -la ./artifacts-combined/ || echo "Directory does not exist"
          echo "Package count: $(ls -1 ./artifacts-combined/*.nupkg 2>/dev/null | wc -l)"

      - name: Checkout repository for meta-package build
        if: success()
        uses: actions/checkout@v6
        with:
          path: repo

      - name: Setup .NET SDK 10 for meta-package
        if: success()
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: 10.0.x

      - name: Build and pack iOS meta-package
        if: success()
        run: |
          # Restore and pack the meta-package using combined packages from parent directory
          LOCAL_SOURCE="$(pwd)/artifacts-combined"
          echo "Restoring iOS meta-package from: $LOCAL_SOURCE"
          ls -la "$LOCAL_SOURCE/" || echo "Local source does not exist"
          dotnet restore repo/Datadog.MAUI.iOS.Binding/Datadog.MAUI.iOS.Binding.csproj --source "$LOCAL_SOURCE" --source https://api.nuget.org/v3/index.json
          dotnet pack repo/Datadog.MAUI.iOS.Binding/Datadog.MAUI.iOS.Binding.csproj --configuration Release --output ./artifacts-combined --no-build
        continue-on-error: true  # iOS bindings not complete yet

      - name: Upload combined iOS packages
        if: always()  # Upload even if packing failed, so dependent jobs can check
        uses: actions/upload-artifact@v6
        with:
          name: ios-nuget-packages
          path: ./artifacts-combined/*.nupkg
          if-no-files-found: ignore  # Don't fail if bindings aren't ready
          retention-days: 30

      - name: Package summary
        run: |
          echo "## iOS NuGet Packages Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -d "./artifacts-combined" ] && [ -n "$(ls -A ./artifacts-combined/*.nupkg 2>/dev/null)" ]; then
            echo "✅ iOS packages built successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Target frameworks included:" >> $GITHUB_STEP_SUMMARY
            echo "- net9.0-ios" >> $GITHUB_STEP_SUMMARY
            echo "- net10.0-ios" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Packages" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            ls -1 ./artifacts-combined/*.nupkg | xargs -n1 basename >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ iOS bindings skipped - requires Objective-C API definitions" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "iOS bindings require Objective-C API definitions to be generated." >> $GITHUB_STEP_SUMMARY
            echo "XCFrameworks have been downloaded and cached successfully." >> $GITHUB_STEP_SUMMARY
          fi

  # Build iOS sample app (requires macOS)
  build-ios-sample:
    name: Build iOS Sample App
    runs-on: macos-latest  # macOS required for iOS app compilation
    needs: [combine-ios-packages, download-xcframeworks]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app/Contents/Developer || sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

      - name: Setup .NET SDK 10
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: 10.0.x

      - name: Install .NET iOS workload
        run: dotnet workload install ios

      - name: Download XCFrameworks for sample app
        uses: actions/download-artifact@v7
        with:
          name: ios-xcframeworks
          path: Datadog.MAUI.iOS.Binding/artifacts/

      - name: Verify XCFrameworks
        run: ls -la Datadog.MAUI.iOS.Binding/artifacts/

      - name: Download iOS packages
        uses: actions/download-artifact@v7
        with:
          name: ios-nuget-packages
          path: ./artifacts
        continue-on-error: true  # Don't fail if packages aren't ready

      - name: Download plugin package
        uses: actions/download-artifact@v7
        with:
          name: datadog-maui-plugin
          path: ./artifacts
        continue-on-error: true  # Plugin might not be built yet

      - name: Check if packages exist
        id: check-packages
        run: |
          if [ -d "./artifacts" ] && [ -n "$(ls -A ./artifacts/*.nupkg 2>/dev/null)" ]; then
            # Check if Datadog.MAUI plugin package exists
            if ls ./artifacts/Datadog.MAUI.*.nupkg 1> /dev/null 2>&1; then
              echo "packages_exist=true" >> $GITHUB_OUTPUT
              echo "✅ iOS packages and Datadog.MAUI plugin found - will build sample app"
            else
              echo "packages_exist=false" >> $GITHUB_OUTPUT
              echo "⚠️ Datadog.MAUI plugin package not found - skipping sample app build"
              echo "Plugin package is built by the build-plugin job in build-all.yml workflow."
            fi
          else
            echo "packages_exist=false" >> $GITHUB_OUTPUT
            echo "⚠️ No iOS packages found - skipping sample app build"
            echo "iOS bindings require Objective-C API definitions to be generated."
          fi

      - name: Get package version from artifacts
        if: steps.check-packages.outputs.packages_exist == 'true'
        id: package-version
        run: |
          # Extract version from first package filename
          PACKAGE=$(ls ./artifacts/*.nupkg 2>/dev/null | head -1 | xargs basename || echo "")
          if [ -n "$PACKAGE" ]; then
            VERSION=$(echo "$PACKAGE" | sed -E 's/.*\.([0-9]+\.[0-9]+\.[0-9]+)\.nupkg/\1/')
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "Detected version: $VERSION from package: $PACKAGE"
          else
            echo "No packages found"
            exit 1
          fi

      - name: Restore MAUI workloads for sample app
        if: steps.check-packages.outputs.packages_exist == 'true'
        run: dotnet workload restore samples/DatadogMauiSample/DatadogMauiSample.csproj

      - name: Build sample app (using Makefile)
        if: steps.check-packages.outputs.packages_exist == 'true'
        env:
          DD_RUM_IOS_CLIENT_TOKEN: ${{ secrets.DD_RUM_IOS_CLIENT_TOKEN }}
          DD_RUM_IOS_APPLICATION_ID: ${{ secrets.DD_RUM_IOS_APPLICATION_ID }}
        run: make sample-build-ios-release-only

      - name: Upload sample app
        if: steps.check-packages.outputs.packages_exist == 'true'
        uses: actions/upload-artifact@v6
        with:
          name: ios-sample-app
          path: |
            samples/DatadogMauiSample/bin/Release/**/*.app
            samples/DatadogMauiSample/bin/Release/**/*.ipa
          if-no-files-found: warn
          retention-days: 7

      - name: Sample build summary
        run: |
          echo "## iOS Sample App Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check-packages.outputs.packages_exist }}" == "true" ]; then
            echo "✅ Sample app compiled successfully using combined NuGet packages" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Package version: ${{ steps.package-version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ **iOS sample app build skipped**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The sample app requires the Datadog.MAUI plugin package built by build-all.yml workflow." >> $GITHUB_STEP_SUMMARY
            echo "Individual binding packages can be used directly once iOS bindings are generated." >> $GITHUB_STEP_SUMMARY
          fi
