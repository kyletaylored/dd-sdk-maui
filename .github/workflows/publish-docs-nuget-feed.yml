name: Deploy Docs + NuGet Feed to GitHub Pages

# This workflow runs when:
# 1. Documentation files are pushed to main (docs/** or _config.base.yml)
# 2. A GitHub release is published (updates NuGet feed with release packages)
# 3. Manually triggered via workflow_dispatch

on:
  push:
    branches: ["main"]
    paths:
      - "docs/**"
      - "_config.base.yml"
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      # --- Pages vars (origin/base_path) ---
      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v5

      # --- Generate Jekyll config dynamically (keep your current approach) ---
      - name: Generate Jekyll config from template
        run: |
          cp docs/_config.base.yml docs/_config.yml

          cat >> docs/_config.yml << 'EOF'

          # --- dynamically injected by GitHub Actions ---

          url: "${{ steps.pages.outputs.origin }}"
          baseurl: "${{ steps.pages.outputs.base_path }}"
          repository: "${{ github.repository }}"

          aux_links:
            "View source on GitHub":
              - "${{ github.server_url }}/${{ github.repository }}"
            "Report an Issue":
              - "${{ github.server_url }}/${{ github.repository }}/issues/new"
            "NuGet Feed":
              - "${{ steps.pages.outputs.origin }}${{ steps.pages.outputs.base_path }}/nuget/index.json"


          aux_links_new_tab: true

          gh_edit_link: true
          gh_edit_link_text: "Edit this page on GitHub"
          gh_edit_repository: "${{ github.server_url }}/${{ github.repository }}"
          gh_edit_branch: "${{ github.ref_name }}"
          gh_edit_source: "docs"
          gh_edit_view_mode: "edit"
          EOF

          echo "Generated docs/_config.yml:"
          tail -n +1 docs/_config.yml

      # --- Build docs site ---
      - name: Build with Jekyll
        uses: actions/jekyll-build-pages@v1
        with:
          source: ./docs
          destination: ./_site
          future: false
          verbose: true

      # --- Build NuGet feed into _site/nuget ---
      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "8.0.x"

      - name: Download release packages (if from release event)
        if: github.event_name == 'release'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p pkgs
          echo "Downloading packages from release ${{ github.event.release.tag_name }}..."
          gh release download ${{ github.event.release.tag_name }} \
            --pattern "*.nupkg" \
            --dir ./pkgs || echo "No packages found in release"

      - name: Build packages (if not from release)
        if: github.event_name != 'release'
        run: |
          echo "Not a release event, skipping package build"
          echo "NuGet feed will only be updated during releases"
          mkdir -p pkgs

      - name: Install Sleet
        run: dotnet tool install -g sleet

      - name: Generate sleet.json dynamically (baseURI uses Pages origin + base_path)
        run: |
          cat > sleet.json <<'JSON'
          {
            "username": "github-actions[bot]",
            "useremail": "github-actions[bot]@users.noreply.github.com",
            "sources": [
              {
                "name": "pages",
                "type": "local",
                "path": "./_site/nuget",
                "baseURI": "__BASEURI__"
              }
            ]
          }
          JSON

          BASEURI="${{ steps.pages.outputs.origin }}${{ steps.pages.outputs.base_path }}/nuget/"
          # safe string replace
          python - <<PY
          import pathlib
          p = pathlib.Path("sleet.json")
          s = p.read_text()
          s = s.replace("__BASEURI__", "${BASEURI}")
          p.write_text(s)
          print("baseURI:", "${BASEURI}")
          PY

      - name: Init feed (if missing)
        run: |
          if [ ! -f "_site/nuget/index.json" ]; then
            sleet init --config sleet.json --source pages
          fi

      - name: Push packages to feed
        run: |
          sleet push ./pkgs --config sleet.json --source pages --skip-existing

      - name: Build packages index for NuGet Explorer
        run: |
          python - <<'PY'
          import json
          import os
          from pathlib import Path

          root = Path("_site/nuget/flatcontainer")
          out = Path("_site/nuget/packages.json")
          out.parent.mkdir(parents=True, exist_ok=True)

          packages = []
          if root.exists():
            for pkg_dir in sorted([p for p in root.iterdir() if p.is_dir()], key=lambda p: p.name):
              pkg_id = pkg_dir.name
              versions = []
              prerelease_versions = []
              for ver_dir in sorted([p for p in pkg_dir.iterdir() if p.is_dir()], key=lambda p: p.name):
                v = ver_dir.name
                versions.append(v)
                if "-" in v:
                  prerelease_versions.append(v)

              latest = versions[-1] if versions else None
              latest_stable = None
              for v in reversed(versions):
                if "-" not in v:
                  latest_stable = v
                  break

              packages.append({
                "id": pkg_id,
                "versions": versions,
                "latest": latest,
                "latestStable": latest_stable,
                "hasPrerelease": len(prerelease_versions) > 0
              })

          data = {
            "generatedAtUtc": __import__("datetime").datetime.utcnow().isoformat() + "Z",
            "count": len(packages),
            "packages": packages
          }
          out.write_text(json.dumps(data, indent=2))
          print(f"Wrote {out} with {len(packages)} packages")
          PY

      # --- Upload Pages artifact ---
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./_site

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
